#include <stdio.h>
#include <stdlib.h>
#include "mlff_types.h"
#include "gmp_deriv_descriptor.h"
#ifndef M_PI
#define M_PI 3.14159265358979323846
#endif
#include <math.h>

int main(){
    // Manually input atom positions from Al supercell. Can call sparc etc to replace. Format should match sparc outputs.
    double atom_pos[108*3] = {0.000000000000000000e+00,0.000000000000000000e+00,0.000000000000000000e+00,0.000000000000000000e+00,2.024999999999999911e+00,2.024999999999999911e+00,2.024999999999999911e+00,0.000000000000000000e+00,2.024999999999999911e+00,2.024999999999999911e+00,2.024999999999999911e+00,0.000000000000000000e+00,0.000000000000000000e+00,0.000000000000000000e+00,4.049999999999999822e+00,0.000000000000000000e+00,2.024999999999999911e+00,6.074999999999999289e+00,2.024999999999999911e+00,0.000000000000000000e+00,6.074999999999999289e+00,2.024999999999999911e+00,2.024999999999999911e+00,4.049999999999999822e+00,0.000000000000000000e+00,0.000000000000000000e+00,8.099999999999999645e+00,0.000000000000000000e+00,2.024999999999999911e+00,1.012500000000000000e+01,2.024999999999999911e+00,0.000000000000000000e+00,1.012500000000000000e+01,2.024999999999999911e+00,2.024999999999999911e+00,8.099999999999999645e+00,0.000000000000000000e+00,4.049999999999999822e+00,0.000000000000000000e+00,0.000000000000000000e+00,6.074999999999999289e+00,2.024999999999999911e+00,2.024999999999999911e+00,4.049999999999999822e+00,2.024999999999999911e+00,2.024999999999999911e+00,6.074999999999999289e+00,0.000000000000000000e+00,0.000000000000000000e+00,4.049999999999999822e+00,4.049999999999999822e+00,0.000000000000000000e+00,6.074999999999999289e+00,6.074999999999999289e+00,2.024999999999999911e+00,4.049999999999999822e+00,6.074999999999999289e+00,2.024999999999999911e+00,6.074999999999999289e+00,4.049999999999999822e+00,0.000000000000000000e+00,4.049999999999999822e+00,8.099999999999999645e+00,0.000000000000000000e+00,6.074999999999999289e+00,1.012500000000000000e+01,2.024999999999999911e+00,4.049999999999999822e+00,1.012500000000000000e+01,2.024999999999999911e+00,6.074999999999999289e+00,8.099999999999999645e+00,0.000000000000000000e+00,8.099999999999999645e+00,0.000000000000000000e+00,0.000000000000000000e+00,1.012500000000000000e+01,2.024999999999999911e+00,2.024999999999999911e+00,8.099999999999999645e+00,2.024999999999999911e+00,2.024999999999999911e+00,1.012500000000000000e+01,0.000000000000000000e+00,0.000000000000000000e+00,8.099999999999999645e+00,4.049999999999999822e+00,0.000000000000000000e+00,1.012500000000000000e+01,6.074999999999999289e+00,2.024999999999999911e+00,8.099999999999999645e+00,6.074999999999999289e+00,2.024999999999999911e+00,1.012500000000000000e+01,4.049999999999999822e+00,0.000000000000000000e+00,8.099999999999999645e+00,8.099999999999999645e+00,0.000000000000000000e+00,1.012500000000000000e+01,1.012500000000000000e+01,2.024999999999999911e+00,8.099999999999999645e+00,1.012500000000000000e+01,2.024999999999999911e+00,1.012500000000000000e+01,8.099999999999999645e+00,4.049999999999999822e+00,0.000000000000000000e+00,0.000000000000000000e+00,4.049999999999999822e+00,2.024999999999999911e+00,2.024999999999999911e+00,6.074999999999999289e+00,0.000000000000000000e+00,2.024999999999999911e+00,6.074999999999999289e+00,2.024999999999999911e+00,0.000000000000000000e+00,4.049999999999999822e+00,0.000000000000000000e+00,4.049999999999999822e+00,4.049999999999999822e+00,2.024999999999999911e+00,6.074999999999999289e+00,6.074999999999999289e+00,0.000000000000000000e+00,6.074999999999999289e+00,6.074999999999999289e+00,2.024999999999999911e+00,4.049999999999999822e+00,4.049999999999999822e+00,0.000000000000000000e+00,8.099999999999999645e+00,4.049999999999999822e+00,2.024999999999999911e+00,1.012500000000000000e+01,6.074999999999999289e+00,0.000000000000000000e+00,1.012500000000000000e+01,6.074999999999999289e+00,2.024999999999999911e+00,8.099999999999999645e+00,4.049999999999999822e+00,4.049999999999999822e+00,0.000000000000000000e+00,4.049999999999999822e+00,6.074999999999999289e+00,2.024999999999999911e+00,6.074999999999999289e+00,4.049999999999999822e+00,2.024999999999999911e+00,6.074999999999999289e+00,6.074999999999999289e+00,0.000000000000000000e+00,4.049999999999999822e+00,4.049999999999999822e+00,4.049999999999999822e+00,4.049999999999999822e+00,6.074999999999999289e+00,6.074999999999999289e+00,6.074999999999999289e+00,4.049999999999999822e+00,6.074999999999999289e+00,6.074999999999999289e+00,6.074999999999999289e+00,4.049999999999999822e+00,4.049999999999999822e+00,4.049999999999999822e+00,8.099999999999999645e+00,4.049999999999999822e+00,6.074999999999999289e+00,1.012500000000000000e+01,6.074999999999999289e+00,4.049999999999999822e+00,1.012500000000000000e+01,6.074999999999999289e+00,6.074999999999999289e+00,8.099999999999999645e+00,4.049999999999999822e+00,8.099999999999999645e+00,0.000000000000000000e+00,4.049999999999999822e+00,1.012500000000000000e+01,2.024999999999999911e+00,6.074999999999999289e+00,8.099999999999999645e+00,2.024999999999999911e+00,6.074999999999999289e+00,1.012500000000000000e+01,0.000000000000000000e+00,4.049999999999999822e+00,8.099999999999999645e+00,4.049999999999999822e+00,4.049999999999999822e+00,1.012500000000000000e+01,6.074999999999999289e+00,6.074999999999999289e+00,8.099999999999999645e+00,6.074999999999999289e+00,6.074999999999999289e+00,1.012500000000000000e+01,4.049999999999999822e+00,4.049999999999999822e+00,8.099999999999999645e+00,8.099999999999999645e+00,4.049999999999999822e+00,1.012500000000000000e+01,1.012500000000000000e+01,6.074999999999999289e+00,8.099999999999999645e+00,1.012500000000000000e+01,6.074999999999999289e+00,1.012500000000000000e+01,8.099999999999999645e+00,8.099999999999999645e+00,0.000000000000000000e+00,0.000000000000000000e+00,8.099999999999999645e+00,2.024999999999999911e+00,2.024999999999999911e+00,1.012500000000000000e+01,0.000000000000000000e+00,2.024999999999999911e+00,1.012500000000000000e+01,2.024999999999999911e+00,0.000000000000000000e+00,8.099999999999999645e+00,0.000000000000000000e+00,4.049999999999999822e+00,8.099999999999999645e+00,2.024999999999999911e+00,6.074999999999999289e+00,1.012500000000000000e+01,0.000000000000000000e+00,6.074999999999999289e+00,1.012500000000000000e+01,2.024999999999999911e+00,4.049999999999999822e+00,8.099999999999999645e+00,0.000000000000000000e+00,8.099999999999999645e+00,8.099999999999999645e+00,2.024999999999999911e+00,1.012500000000000000e+01,1.012500000000000000e+01,0.000000000000000000e+00,1.012500000000000000e+01,1.012500000000000000e+01,2.024999999999999911e+00,8.099999999999999645e+00,8.099999999999999645e+00,4.049999999999999822e+00,0.000000000000000000e+00,8.099999999999999645e+00,6.074999999999999289e+00,2.024999999999999911e+00,1.012500000000000000e+01,4.049999999999999822e+00,2.024999999999999911e+00,1.012500000000000000e+01,6.074999999999999289e+00,0.000000000000000000e+00,8.099999999999999645e+00,4.049999999999999822e+00,4.049999999999999822e+00,8.099999999999999645e+00,6.074999999999999289e+00,6.074999999999999289e+00,1.012500000000000000e+01,4.049999999999999822e+00,6.074999999999999289e+00,1.012500000000000000e+01,6.074999999999999289e+00,4.049999999999999822e+00,8.099999999999999645e+00,4.049999999999999822e+00,8.099999999999999645e+00,8.099999999999999645e+00,6.074999999999999289e+00,1.012500000000000000e+01,1.012500000000000000e+01,4.049999999999999822e+00,1.012500000000000000e+01,1.012500000000000000e+01,6.074999999999999289e+00,8.099999999999999645e+00,8.099999999999999645e+00,8.099999999999999645e+00,0.000000000000000000e+00,8.099999999999999645e+00,1.012500000000000000e+01,2.024999999999999911e+00,1.012500000000000000e+01,8.099999999999999645e+00,2.024999999999999911e+00,1.012500000000000000e+01,1.012500000000000000e+01,0.000000000000000000e+00,8.099999999999999645e+00,8.099999999999999645e+00,4.049999999999999822e+00,8.099999999999999645e+00,1.012500000000000000e+01,6.074999999999999289e+00,1.012500000000000000e+01,8.099999999999999645e+00,6.074999999999999289e+00,1.012500000000000000e+01,1.012500000000000000e+01,4.049999999999999822e+00,8.099999999999999645e+00,8.099999999999999645e+00,8.099999999999999645e+00,8.099999999999999645e+00,1.012500000000000000e+01,1.012500000000000000e+01,1.012500000000000000e+01,8.099999999999999645e+00,1.012500000000000000e+01,1.012500000000000000e+01,1.012500000000000000e+01,8.099999999999999645e+00};

    double *atom_pos_p = atom_pos;
    // Array of atomic numbers
    int atom_indices[108];
    for (int i = 0; i < 108; i ++) atom_indices[i] = 13;
    int *atom_indices_p = atom_indices;
    // SPARC neighbor list seems to store atom type sequentially from 0. This converts SPARC atom type to atomic number. Will need better implementation beyond simple test case
    int atom_type_to_indices[1] = {13};
    int *atom_type_to_indices_p = atom_type_to_indices;
    // Atoms in system
    int atom_num = 108;
    // Indices of atoms requiring descriptor calculation
    int cal_atoms[108];
    for (int i = 0; i < 108; i++){
        cal_atoms[i] = i;
    }
    int *cal_atoms_p = cal_atoms;
    int cal_num = 108;
    // Integer GMP params - mcsh order, square (1) or square root (0) features, solid (1) or surface (0) harmonics
    int params_i[15][3] = {{0,1,0},
    {0,1,0},
    {0,1,0},
    {1,1,0},
    {1,1,0},
    {1,1,0},
    {2,1,0},
    {2,1,0},
    {2,1,0},
    {3,1,0},
    {3,1,0},
    {3,1,0},
    {4,1,0},
    {4,1,0},
    {4,1,0}};
    int *params_ip[15];
    int **params_ip_all;
    for (int i =0; i < 15; i ++){
            params_ip[i] = params_i[i];
        }
    params_ip_all = params_ip;
    // Double GMP params - sigma, 1 (always, not sure what this actually is), sigma manipulation, sigma manipulation, cutoff, sigma manipulation
    // Adding file reading functionality, not necessary. Not sure what will be easiest.
    /*
    double params_d[15][6] = {{1.00000000e-01,1.00000000e+00,6.34936359e+01,5.00000000e+01,
    1.80000000e+01,1.00000000e+00},
    {6.30000000e-01,1.00000000e+00,2.53926805e-01,1.25976316e+00,
    1.80000000e+01,1.00000000e+00},
    {3.98000000e+00,1.00000000e+00,1.00711945e-03,3.15648595e-02,
    1.80000000e+01,1.00000000e+00},
    {1.00000000e-01,1.00000000e+00,6.34936359e+01,5.00000000e+01,
    1.80000000e+01,1.00000000e+00},
    {6.30000000e-01,1.00000000e+00,2.53926805e-01,1.25976316e+00,
    1.80000000e+01,1.00000000e+00},
    {3.98000000e+00,1.00000000e+00,1.00711945e-03,3.15648595e-02,
    1.80000000e+01,1.00000000e+00},
    {1.00000000e-01,1.00000000e+00,6.34936359e+01,5.00000000e+01,
    1.80000000e+01,1.00000000e+00},
    {6.30000000e-01,1.00000000e+00,2.53926805e-01,1.25976316e+00,
    1.80000000e+01,1.00000000e+00},
    {3.98000000e+00,1.00000000e+00,1.00711945e-03,3.15648595e-02,
    1.80000000e+01,1.00000000e+00},
    {1.00000000e-01,1.00000000e+00,6.34936359e+01,5.00000000e+01,
    1.80000000e+01,1.00000000e+00},
    {6.30000000e-01,1.00000000e+00,2.53926805e-01,1.25976316e+00,
    1.80000000e+01,1.00000000e+00},
    {3.98000000e+00,1.00000000e+00,1.00711945e-03,3.15648595e-02,
    1.80000000e+01,1.00000000e+00},
    {1.00000000e-01,1.00000000e+00,6.34936359e+01,5.00000000e+01,
    1.80000000e+01,1.00000000e+00},
    {6.30000000e-01,1.00000000e+00,2.53926805e-01,1.25976316e+00,
    1.80000000e+01,1.00000000e+00},
    {3.98000000e+00,1.00000000e+00,1.00711945e-03,3.15648595e-02,
    1.80000000e+01,1.00000000e+00}};

    double *params_dp[15];
    double **params_dp_all;
    for (int i =0; i < 15; i ++){
            params_dp[i] = params_d[i];
        }
    params_dp_all = params_dp;
    */

    double *params_di = (double*) malloc(sizeof(double)*4);
    FILE *in_file = fopen("GMP.txt", "r");

    if (NULL == in_file) printf("File cannont be opened\n");

    for (int i =0; i < 4; i++){
        fscanf(in_file,"%lf",&params_di[i]);
    }
    double sigmas[3] = {params_di[0],params_di[1],params_di[2]};
    double cutoff = params_di[3];

    double **params_d = (double**) malloc(sizeof(double*)*15);
    for (int i = 0; i < 15; i++) params_d[i] = (double*) malloc(sizeof(double)*6);

    for (int i = 0; i < 5; i++){
        for (int j = 0; j < 3; j++){
            params_d[i*3+j][0] = sigmas[j];
            params_d[i*3+j][1] = 1.0;
            params_d[i*3+j][2] = pow(1/(sigmas[j]*sqrt(2.0*M_PI)),3);
            params_d[i*3+j][3] = 1/(2*pow(sigmas[j],2));
            params_d[i*3+j][4] = cutoff;
            params_d[i*3+j][5] = 1.0;
        }
    }
    
    // Total number of descriptors in vector/atom
    int nmcsh = 15;
    // Primitive gaussain paramaters - can add functionality to be read from file
    double atom_gaussian[1][8] = {{0.3730494069109985,0.7344318799434225,516.9378247134416,13.577027904536275,
    889298.9729349068,12.0315655354449,-889796.765560644,12.032681865001077}};

    double *atom_gaussian_p[1];
    double **atom_gaussian_all;
    for (int i =0; i < 1; i ++){
            atom_gaussian_p[i] = atom_gaussian[i];
        }
    atom_gaussian_all = atom_gaussian_p;
    // Number of primitive gaussians/atom
    int ngaussians[1] = {4};
    int *ngaussians_p = ngaussians;
    // Convert atomic number to order in gaussian lists
    int element_index_to_order[120] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
    int *element_index_to_order_p = element_index_to_order;

    NeighList *nlist;
	GMPObj *gmp_str;
    FeatureScaler *ftr_scale;
	int *Z, *BC, *atomtyp;
    int Ntypes = 1, n_atom = 108, nAtomv[1] = {108};
	Z = (int *)malloc(Ntypes*sizeof(int));
	for (int i=0; i <Ntypes; i++){
		Z[i] = 1;//pSPARC->Znucl[i];
	}

	nlist = (NeighList *) malloc(sizeof(NeighList)*1);
	gmp_str = (GMPObj *) malloc(sizeof(GMPObj)*1);
    ftr_scale = (FeatureScaler *) malloc(sizeof(FeatureScaler)*1);

	double *cell, F_estimate_max;
    // Cutoff distance
    double rcut = 18;
    // BC - boundary conditions 1 = periodic
	BC = (int*)malloc(3*sizeof(int));
    //cell - unit cell
	cell =(double *) malloc(3*sizeof(double));
    // atomtyp - array storing atoms types 
	atomtyp = (int *) malloc(n_atom*sizeof(int));
	BC[0] = 1; BC[1] = 1; BC[2] = 1;
	cell[0] = 12.15;
	cell[1] = 12.15;
	cell[2] = 12.15;
    
	int count = 0;
	for (int i=0; i < Ntypes; i++){
		for (int j=0; j < nAtomv[i]; j++){
			atomtyp[count] = i;
			count++;
		}
	}

	//printf("sparc_mlff_interface_firstMD\n");
	//printf("--------------------\n");
	//printf("Initializing nlist ... \n");
	initialize_nlist(nlist, n_atom, rcut, Ntypes);
	//printf("Initialization of nlist done.\n");
	//printf("Building nlist ... \n");
	build_nlist(rcut, Ntypes, n_atom, atom_pos_p, atomtyp, BC, cell, nlist);
	//printf("Building nlist done. \n");

    // specifying if descriptor calculation is for training or prediction - determines if scaling factors are computed for standardization
    // This requires smarter implementation
    ftr_scale->train = 1;

    //printf("Initializing GMPObj. \n");
    initialize_gmpObj(gmp_str, nlist, cal_atoms, cal_num,params_ip_all, params_d, nmcsh, atom_gaussian_all, ngaussians, element_index_to_order_p);
    //printf("GMPObj initialized");
    
    //printf("Building soapxx ... \n");
    build_gmpObj(gmp_str, nlist, ftr_scale, nmcsh, atom_pos_p, params_ip_all, params_d, atom_gaussian_all, ngaussians, element_index_to_order_p,atom_type_to_indices_p,atom_indices_p);
    //printf("Building soap donexx. \n");

    for (int i=0; i < 108; i++){
        for (int j=0; j < 15; j++){
            printf("%d,%d,%f",i,j,gmp_str->X[i][j]);
            for (int k=0; k<108; k++){
                printf(",%f,%f,%f",gmp_str->dX_dX[i][k][j],gmp_str->dX_dY[i][k][j],gmp_str->dX_dZ[i][k][j]);
            }
            printf("\n");
        }
    }

    for (int i = 0; i < 15; i++) {
        printf("%f,",ftr_scale->stdev_colWise[i]);
    }

    return 0;
}